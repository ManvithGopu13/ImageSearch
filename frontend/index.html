<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Search RAG System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 30px;
            padding: 30px;
        }
        
        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .card h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        
        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
        }
        
        .upload-area:hover {
            background: #f0f2ff;
            border-color: #764ba2;
        }
        
        .upload-area.dragover {
            background: #e8ebff;
            border-color: #764ba2;
        }
        
        .upload-icon {
            font-size: 3em;
            margin-bottom: 10px;
        }
        
        input[type="file"] {
            display: none;
        }
        
        .search-box {
            position: relative;
        }
        
        .search-input {
            width: 100%;
            padding: 15px 50px 15px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            font-size: 1em;
            transition: all 0.3s;
        }
        
        .search-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .search-btn {
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .search-btn:hover {
            transform: translateY(-50%) scale(1.05);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        
        .stat-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }
        
        .stat-label {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }
        
        .results-area {
            min-height: 400px;
        }
        
        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .result-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .result-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }
        
        .result-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            background: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .result-image img {
            transition: transform 0.3s ease;
        }
        
        .result-card:hover .result-image img {
            transform: scale(1.05);
        }
        
        /* Hover image preview animations */
        #hoverImagePreview {
            animation: fadeInPreview 0.2s ease-in;
        }
        
        @keyframes fadeInPreview {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(10px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }
        
        #hoverImagePreview img {
            animation: imageLoad 0.3s ease-out;
        }
        
        @keyframes imageLoad {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .result-info {
            padding: 15px;
        }
        
        .result-caption {
            font-size: 0.9em;
            color: #333;
            margin-bottom: 10px;
            line-height: 1.4;
        }
        
        .result-score {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: bold;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
            font-size: 1.2em;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: all 0.3s;
            width: 100%;
            margin-top: 10px;
        }
        
        .btn:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: #6c757d;
        }
        
        .explanation {
            background: #e8f4fd;
            border-left: 4px solid #667eea;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-style: italic;
        }
        
        #visualizationFrame {
            width: 100%;
            height: 600px;
            border: none;
            border-radius: 12px;
            background: white;
        }
        
        .tab-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .tab-btn {
            flex: 1;
            padding: 12px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .tab-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .tab-content {
            display: none;
            overflow: auto;
        }
        
        .tab-content.active {
            display: block;
        }
        
        #visualizationContainer {
            width: 100%;
            overflow: visible;
        }
        
        #vizDisplay {
            width: 100%;
            position: relative;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîç Image Search RAG System</h1>
            <p>AI-Powered Image Search with OCR, Object Detection & Natural Language</p>
        </div>
        
        <div class="main-content">
            <!-- Sidebar -->
            <div class="sidebar">
                <!-- Upload Card -->
                <div class="card">
                    <h2>üì§ Upload Images</h2>
                    <div class="upload-area" id="uploadArea">
                        <div class="upload-icon">üìÅ</div>
                        <p><strong>Click or drag images here</strong></p>
                        <p style="font-size: 0.9em; color: #666; margin-top: 10px;">
                            Supports multiple files
                        </p>
                    </div>
                    <input type="file" id="fileInput" multiple accept="image/*">
                    <div id="uploadStatus" style="margin-top: 15px; font-size: 0.9em;"></div>
                </div>
                
                <!-- Stats Card -->
                <div class="card">
                    <h2>üìä Database Stats</h2>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-value" id="totalImages">0</div>
                            <div class="stat-label">Total Images</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="withText">0%</div>
                            <div class="stat-label">With Text</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="withObjects">0%</div>
                            <div class="stat-label">With Objects</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="withCaptions">0%</div>
                            <div class="stat-label">With Captions</div>
                        </div>
                    </div>
                    <button class="btn" onclick="loadStats()">üîÑ Refresh Stats</button>
                </div>
                
                <!-- Visualization Button -->
                <div class="card">
                    <h2>üìà Visualization</h2>
                    <button class="btn" onclick="showVisualization()">View Vector Space</button>
                </div>
            </div>
            
            <!-- Main Content Area -->
            <div class="results-area">
                <div class="card">
                    <div class="tab-buttons">
                        <button class="tab-btn active" onclick="switchTab('search')">üîç Search</button>
                        <button class="tab-btn" onclick="switchTab('results')">üìã Results</button>
                        <button class="tab-btn" onclick="switchTab('visualization')">üìä Visualization</button>
                    </div>
                    
                    <!-- Search Tab -->
                    <div id="searchTab" class="tab-content active">
                        <h2>Search Images</h2>
                        <div class="search-box">
                            <input 
                                type="text" 
                                class="search-input" 
                                id="searchInput" 
                                placeholder="Search for images (e.g., 'cat on a sunny day', 'document with text', 'person smiling')"
                                onkeypress="handleSearchKeypress(event)"
                            >
                            <button class="search-btn" onclick="performSearch()">Search</button>
                        </div>
                        
                        <div style="margin-top: 20px;">
                            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                <input type="checkbox" id="useLLM" checked>
                                <span>Use AI-powered query enhancement (NVIDIA LLM)</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Results Tab -->
                    <div id="resultsTab" class="tab-content">
                        <div id="resultsContainer">
                            <div style="text-align: center; padding: 60px 20px; color: #999;">
                                <div style="font-size: 4em; margin-bottom: 20px;">üñºÔ∏è</div>
                                <p style="font-size: 1.2em;">Search for images to see results here</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Visualization Tab -->
                    <div id="visualizationTab" class="tab-content">
                        <div id="visualizationContainer">
                            <div style="text-align: center; padding: 60px 20px; color: #999;">
                                <div style="font-size: 4em; margin-bottom: 20px;">üìà</div>
                                <p style="font-size: 1.2em;">Click "View Vector Space" to visualize your database</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        const API_BASE = 'http://localhost:8000';
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadStats();
            setupUploadHandlers();
        });
        
        // Tab switching
        function switchTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');
        }
        
        // Upload handlers
        function setupUploadHandlers() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');
            
            uploadArea.onclick = () => fileInput.click();
            
            uploadArea.ondragover = (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            };
            
            uploadArea.ondragleave = () => {
                uploadArea.classList.remove('dragover');
            };
            
            uploadArea.ondrop = (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                handleFiles(e.dataTransfer.files);
            };
            
            fileInput.onchange = (e) => {
                handleFiles(e.target.files);
            };
        }
        
        async function handleFiles(files) {
            if (!files.length) return;
            
            const uploadStatus = document.getElementById('uploadStatus');
            uploadStatus.innerHTML = `<div class="loading">
                <div class="spinner"></div>
                <p>Uploading and processing ${files.length} image(s)...</p>
            </div>`;
            
            try {
                const formData = new FormData();
                for (let file of files) {
                    formData.append('files', file);
                }
                
                const response = await fetch(`${API_BASE}/upload/batch`, {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                uploadStatus.innerHTML = `
                    <div style="background: #d4edda; color: #155724; padding: 12px; border-radius: 8px;">
                        ‚úÖ Successfully uploaded: ${result.successful}/${result.total_uploaded}
                    </div>
                `;
                
                loadStats();
                setTimeout(() => uploadStatus.innerHTML = '', 3000);
                
            } catch (error) {
                uploadStatus.innerHTML = `
                    <div style="background: #f8d7da; color: #721c24; padding: 12px; border-radius: 8px;">
                        ‚ùå Error: ${error.message}
                    </div>
                `;
            }
        }
        
        // Load stats
        async function loadStats() {
            try {
                const response = await fetch(`${API_BASE}/stats`);
                const stats = await response.json();
                
                document.getElementById('totalImages').textContent = stats.total_images;
                document.getElementById('withText').textContent = stats.images_with_text_pct.toFixed(1) + '%';
                document.getElementById('withObjects').textContent = stats.images_with_objects_pct.toFixed(1) + '%';
                document.getElementById('withCaptions').textContent = stats.images_with_caption_pct.toFixed(1) + '%';
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }
        
        // Search
        function handleSearchKeypress(event) {
            if (event.key === 'Enter') {
                performSearch();
            }
        }
        
        async function performSearch() {
            const query = document.getElementById('searchInput').value.trim();
            if (!query) {
                alert('Please enter a search query');
                return;
            }
            
            const useLLM = document.getElementById('useLLM').checked;
            const resultsContainer = document.getElementById('resultsContainer');
            
            // Show loading
            resultsContainer.innerHTML = `<div class="loading">
                <div class="spinner"></div>
                <p>Searching for: "${query}"</p>
            </div>`;
            
            // Switch to results tab
            switchTab('results');
            document.querySelectorAll('.tab-btn')[1].classList.add('active');
            
            try {
                const response = await fetch(`${API_BASE}/search`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        query: query,
                        top_k: 10,
                        use_llm: useLLM
                    })
                });
                
                const results = await response.json();
                displayResults(results);
                
            } catch (error) {
                resultsContainer.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #dc3545;">
                        <p style="font-size: 1.2em;">‚ùå Error: ${error.message}</p>
                        <p style="margin-top: 10px;">Make sure the backend server is running.</p>
                    </div>
                `;
            }
        }
        
        function displayResults(results) {
            const container = document.getElementById('resultsContainer');
            
            if (!results.results || results.results.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px; color: #999;">
                        <div style="font-size: 4em; margin-bottom: 20px;">üòï</div>
                        <p style="font-size: 1.2em;">No results found for "${results.query}"</p>
                        <p style="margin-top: 10px;">Try a different search query.</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            
            // Add explanation if available
            if (results.explanation) {
                html += `<div class="explanation">üí° ${results.explanation}</div>`;
            }
            
            // Add enhanced query info
            if (results.enhanced_query && results.enhanced_query !== results.query) {
                html += `<div style="margin-bottom: 20px; padding: 12px; background: #fff3cd; border-radius: 8px;">
                    <strong>Enhanced Query:</strong> ${results.enhanced_query}
                </div>`;
            }
            
            // Add results grid
            html += '<div class="results-grid">';
            
            for (let result of results.results) {
                const metadata = result.metadata;
                const score = (result.similarity_score * 100).toFixed(1);
                const caption = metadata.caption || 'No caption available';
                const objectCount = metadata.object_count || 0;
                const imageId = result.id;
                
                // Get actual image URL
                const imagePath = metadata.file_path || '';
                const imageUrl = imagePath ? `${API_BASE}/${imagePath.replace(/\\/g, '/')}` : '';
                
                html += `
                    <div class="result-card">
                        <div class="result-image" style="background: #f0f0f0; position: relative; overflow: hidden;">
                            ${imageUrl ? 
                                `<img src="${imageUrl}" 
                                     alt="${caption}" 
                                     style="width: 100%; height: 100%; object-fit: cover;"
                                     onerror="this.style.display='none'; this.parentElement.innerHTML='<div style=\\'display:flex;align-items:center;justify-content:center;height:100%;color:#999;font-size:3em\\'>üñºÔ∏è</div>'">` 
                                : 
                                `<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #999; font-size: 3em;">üñºÔ∏è</div>`
                            }
                        </div>
                        <div class="result-info">
                            <div class="result-caption" style="font-size: 0.85em; line-height: 1.3; max-height: 3.9em; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical;">${caption}</div>
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px; flex-wrap: wrap; gap: 5px;">
                                <span class="result-score">${score}% match</span>
                                ${result.boosted ? '<span style="font-size: 0.75em; background: #ffd700; color: #333; padding: 3px 8px; border-radius: 10px; font-weight: bold; margin-left: 5px;">‚≠ê Boosted</span>' : ''}
                                <span style="font-size: 0.85em; color: #666;">
                                    ${objectCount} ${objectCount === 1 ? 'object' : 'objects'}
                                </span>
                            </div>
                            ${metadata.ocr_text ? `<div style="margin-top: 10px; font-size: 0.8em; color: #666; font-style: italic; background: #f9f9f9; padding: 8px; border-radius: 4px;">
                                üìù "${metadata.ocr_text.substring(0, 60)}${metadata.ocr_text.length > 60 ? '...' : ''}"
                            </div>` : ''}
                        </div>
                    </div>
                `;
            }
            
            html += '</div>';
            
            // Count boosted results
            const boostedCount = results.results.filter(r => r.boosted).length;
            
            html += `<div style="margin-top: 20px; padding: 15px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 8px; text-align: center; border: 2px solid #667eea;">
                <strong style="color: #667eea; font-size: 1.2em;">üéØ ${results.results.length} Smart Matches Found</strong>
                <div style="margin-top: 8px; color: #666; font-size: 0.9em;">
                    ${boostedCount > 0 ? `‚≠ê ${boostedCount} enhanced by keyword matching ‚Ä¢ ` : ''}
                    Multi-field semantic search ‚Ä¢ Showing top ${results.results.length} of ${results.total_found}
                </div>
            </div>`;
            
            container.innerHTML = html;
        }
        
        // Visualization
        async function showVisualization() {
            const container = document.getElementById('visualizationContainer');

            container.innerHTML = `
                <div style="margin-bottom: 20px; text-align: center;">
                    <button onclick="showNetworkMap()" style="padding: 12px 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; margin-right: 10px; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);">
                        üåê Network Map View
                    </button>
                    <button onclick="show3DVisualization()" style="padding: 12px 24px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 15px rgba(245, 87, 108, 0.4);">
                        üìä 3D Vector Space
                    </button>
                </div>
                <div id="vizDisplay"></div>
            `;

            // Switch to visualization tab
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-btn')[2].classList.add('active');
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById('visualizationTab').classList.add('active');

            // Default to network map
            showNetworkMap();
        }

        async function showNetworkMap() {
            const container = document.getElementById('vizDisplay');
            
            container.innerHTML = `<div class="loading">
                <div class="spinner"></div>
                <p>Generating network graph...</p>
                <p style="font-size: 0.9em; margin-top: 10px;">Building NetworkX-style visualization</p>
            </div>`;

            try {
                const response = await fetch(`${API_BASE}/visualize/network?method=pca&sample_size=50&n_clusters=6&connection_threshold=0.75`);
                const result = await response.json();

                if (result.error) {
                    throw new Error(result.error);
                }

                console.log('Network data received:', result);

                // Create container for visualization
                container.innerHTML = '<div id="networkPlot" style="width: 100%; height: 750px; background: rgb(17, 17, 17); border-radius: 8px;"></div>';

                // Configure for 2D network graph
                const config = {
                    responsive: true,
                    displayModeBar: true,
                    displaylogo: false,
                    scrollZoom: true,
                    doubleClick: 'reset',
                    modeBarButtonsToRemove: ['lasso2d', 'select2d']
                };

                // Ensure proper layout
                result.figure.layout.autosize = true;
                result.figure.layout.height = 750;
                result.figure.layout.width = null;  // Auto width

                console.log('Plotting with', result.figure.data.length, 'traces');

                // Render 2D network visualization
                Plotly.newPlot('networkPlot', result.figure.data, result.figure.layout, config).then(() => {
                    console.log('Plot created successfully');
                    
                    // Add hover image preview functionality
                    const plotDiv = document.getElementById('networkPlot');
                    
                    // Remove old preview if exists
                    const oldPreview = document.getElementById('hoverImagePreview');
                    if (oldPreview) oldPreview.remove();
                    
                    // Create floating image preview element
                    const imagePreview = document.createElement('div');
                    imagePreview.id = 'hoverImagePreview';
                    imagePreview.style.cssText = `
                        position: fixed;
                        display: none;
                        z-index: 10000;
                        background: white;
                        border: 3px solid #667eea;
                        border-radius: 12px;
                        padding: 10px;
                        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
                        pointer-events: none;
                        max-width: 300px;
                    `;
                    document.body.appendChild(imagePreview);

                    // Handle hover events to show images
                    plotDiv.on('plotly_hover', function(data) {
                        console.log('Hover event:', data.points[0]);
                        const point = data.points[0];
                        if (point.customdata) {
                            const filename = point.customdata;
                            const imageUrl = `${API_BASE}/uploads/${filename}`;
                            
                            imagePreview.innerHTML = `
                                <img src="${imageUrl}" 
                                     style="width: 100%; border-radius: 8px; display: block;"
                                     onerror="this.parentElement.innerHTML='<div style=\\'padding: 20px; text-align: center;\\'>‚ùå Image not found</div>'">
                            `;
                            imagePreview.style.display = 'block';
                        }
                    });

                    plotDiv.on('plotly_unhover', function() {
                        imagePreview.style.display = 'none';
                    });

                    // Update preview position on mouse move
                    document.addEventListener('mousemove', function(e) {
                        const preview = document.getElementById('hoverImagePreview');
                        if (preview && preview.style.display === 'block') {
                            preview.style.left = (e.pageX + 20) + 'px';
                            preview.style.top = (e.pageY - 150) + 'px';
                        }
                    });
                });

                // Add info message
                const info = document.createElement('div');
                info.style.cssText = 'margin-top: 15px; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; text-align: center; color: white; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);';
                info.innerHTML = `
                    <strong style="font-size: 1.1em;">üåê Network Graph Visualization</strong><br>
                    <span style="font-size: 0.95em; opacity: 0.95; display: block; margin-top: 8px;">
                        ${result.message || 'Network map ready'} ‚Ä¢ 
                        <strong>Hover over nodes to see images</strong> ‚Ä¢
                        Zoom with scroll ‚Ä¢ Pan by dragging ‚Ä¢ Double-click to reset
                    </span>
                `;
                container.appendChild(info);

            } catch (error) {
                console.error('Network visualization error:', error);
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #dc3545;">
                        <p style="font-size: 1.2em;">‚ùå Error: ${error.message}</p>
                        <p style="margin-top: 10px; font-size: 0.9em;">Check browser console for details.</p>
                    </div>
                `;
            }
        }

        async function show3DVisualization() {
            const container = document.getElementById('vizDisplay');

            container.innerHTML = `<div class="loading">
                <div class="spinner"></div>
                <p>Generating 3D vector space...</p>
                <p style="font-size: 0.9em; margin-top: 10px;">Using PCA for faster rendering</p>
            </div>`;

            try {
                const response = await fetch(`${API_BASE}/visualize/3d?method=pca&sample_size=50&n_clusters=5&show_connections=true`);
                const result = await response.json();

                if (result.error) {
                    throw new Error(result.error);
                }

                // Create container for visualization with proper sizing
                container.innerHTML = '<div id="vector3DPlot" style="width: 100%; height: 700px; background: rgb(243, 243, 243); border-radius: 8px; overflow: hidden;"></div>';

                // Render Plotly 3D visualization
                const config = {
                    responsive: true,
                    displayModeBar: true,
                    modeBarButtonsToAdd: ['pan3d', 'zoom3d', 'orbitrotation', 'resetCameraDefault3d'],
                    displaylogo: false,
                    doubleClick: 'reset'
                };

                // Ensure layout fits
                result.figure.layout.autosize = true;
                result.figure.layout.height = 700;

                Plotly.newPlot('vector3DPlot', result.figure.data, result.figure.layout, config);

                // Add info message
                const info = document.createElement('div');
                info.style.cssText = 'margin-top: 15px; padding: 15px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); border-radius: 12px; text-align: center; color: white; box-shadow: 0 4px 15px rgba(245, 87, 108, 0.3);';
                info.innerHTML = `
                    <strong style="font-size: 1.1em;">üìä Interactive 3D Vector Space</strong><br>
                    <span style="font-size: 0.95em; opacity: 0.95; display: block; margin-top: 8px;">
                        ${result.message} ‚Ä¢
                        Labels on points ‚Ä¢
                        Drag to rotate ‚Ä¢ Scroll to zoom ‚Ä¢ Double-click to reset
                    </span>
                `;
                container.appendChild(info);

            } catch (error) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #dc3545;">
                        <p style="font-size: 1.2em;">‚ùå Error: ${error.message}</p>
                        <p style="margin-top: 10px; font-size: 0.9em;">Make sure the server is running and images are uploaded.</p>
                    </div>
                `;
            }
        }
    </script>
    
    <!-- Plotly for visualization -->
    <script src="https://cdn.plot.ly/plotly-2.26.0.min.js"></script>
</body>
</html>

